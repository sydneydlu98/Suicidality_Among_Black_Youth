---
title: "Suicidality Among Black Youth"
author: "Dingxin Lu"
date: '2022-05-11'
output: 
  html_document:
   df_print: paged
   toc: true 
   toc_depth: 2  
   number_sections: false
   toc_float:
     collapsed: true
     smooth_scroll: true
---

# read in data

```{r, warning=FALSE, message=FALSE}
library(dplyr)
library(gtsummary)
library(boot)
library(table1)
library(survey)
library(broom)
library(MASS)
library(jtools)
library(epitools)
library(plyr)
library(pROC)

data <- read.csv("yrbs2019.csv")
```

# subset black data

```{r}
# subsetting black
black_data <- data %>%
  filter(Q5 == "C") %>%
  mutate(QN28 = replace(QN28, which(QN26 == 2 & QN27 == 2), 2)) %>%
  mutate(QN29 = replace(QN29, which(QN26 == 2 & QN27 == 2), 2)) %>%
  mutate(QN29 = replace(QN29, which(QN28 == 2), 2)) %>%
  mutate(QN28 = replace(QN28, which(QN29 == 1), 1)) %>%
  mutate(QN27 = replace(QN27, which(QN26 == 2), 2)) %>%
  mutate(QN28 = replace(QN28, which(QN26 == 2), 2)) %>%
  mutate(QN29 = replace(QN29, which(QN26 == 2), 2)) %>%
  mutate(QN26 = replace(QN26, which(QN27 == 1), 1)) %>%
  mutate(QN26 = replace(QN26, which(QN28 == 1), 1)) %>%
  mutate(QN26 = replace(QN26, which(QN29 == 1), 1)) %>%
  filter(QN26 != 'NA' | QN27 != 'NA' | QN28 != 'NA' | QN29 != 'NA') 
```

# Statistical analysis

```{r}
# make the independent variable 0 or 1
black_data[black_data == 2] <- 0
```

```{r}
# convert age variable
black_data$QN1 <- substr(black_data$Q1, 1, 2)
black_data$QN1 <- as.numeric(black_data$QN1)

# convert gender into: male = 0 and female = 1
black_data$QN2[black_data$Q2 == "Female"] <- 1      
black_data$QN2[black_data$Q2 == "Male"] <- 0  
black_data$QN2[black_data$Q2 == "Missing"] <- NA

# convert grade into numerical variabes
black_data$QN3[black_data$Q3 == "9th grade"] <- 0      
black_data$QN3[black_data$Q3 == "10th grade"] <- 1 
black_data$QN3[black_data$Q3 == "11th grade"] <- 2
black_data$QN3[black_data$Q3 == "12th grade"] <- 3 
black_data$QN3[black_data$Q3 == "Missing"] <- NA
black_data$QN3[black_data$Q3 == "Ungraded or other grade"] <- NA

# convert hispanic or latino into: yes = 1, no = 0
black_data$QN4[black_data$Q4 == "Yes"] <- 1      
black_data$QN4[black_data$Q4 == "No"] <- 0  
black_data$QN4[black_data$Q4 == "Missing"] <- NA 

# BMI (0 = normal, 1 = overweight, 2 = obese)
black_data$BMI <- (black_data$Q7)/(black_data$Q6)^2
black_data$QN5 <- cut(black_data$BMI,
                      breaks = c(0, 24.9, 39.9, 80),
                      labels = c(0, 1, 2))

# QN65 is un-usable, because it is the variable for "During your life, with whom have you had sexual contact?"; It has the selection of male, female, Females and males and I have never had sexual contact  which are not helpful for analysis

# QN66 is "sexual orientation", such as Heterosexual (straight), Gay or lesbian, Bisexual and Not sure.
# convert QN66 to: Heterosexual (straight) = 0; Gay or lesbian = 1; Bisexual = 2; Not sure = NA
black_data$QN66[black_data$Q66 == "Heterosexual (straight)"] <- 0      
black_data$QN66[black_data$Q66 == "Gay or lesbian"] <- 1  
black_data$QN66[black_data$Q66 == "Bisexual"] <- 1
black_data$QN66[black_data$Q66 == "Missing"] <- NA 
black_data$QN66[black_data$Q66 == "Not sure"] <- NA
```

```{r}
# weighted design data
yrbsdes <- svydesign(id=~PSU, 
                     weight=~WEIGHT, 
                     strata=~STRATUM, 
                     data=black_data, 
                     nest=TRUE)
```

# QN26

```{r}
part1 <- c()
for (i in 1:5){
      part1[i] <- summary(svyglm(reformulate(paste0('factor(QN', i, ')'), response = 'factor(QN26)'), design = yrbsdes, data = black_data, family = quasibinomial()))$coef[-1, "Pr(>|t|)"]
      df1 <- data.frame(value = part1) %>% na.omit()
}

part2 <- c()
for (i in 1:18){
      part2[i] <- summary(svyglm(reformulate(paste0('factor(QN', i+7, ')'), response = 'factor(QN26)'), design = yrbsdes, data = black_data, family = quasibinomial()))$coef[-1, "Pr(>|t|)"]
      df2 <- data.frame(value = part2) %>% na.omit()
}

part3 <- c()
for (i in 23:57){
      part3[i] <- summary(svyglm(reformulate(paste0('factor(QN', i+7, ')'), response = 'factor(QN26)'), design = yrbsdes, data = black_data, family = quasibinomial()))$coef[-1, "Pr(>|t|)"]
      df3 <- data.frame(value = part3) %>% na.omit()
}

part4 <- c()
for (i in 59:92){
      part4[i] <- summary(svyglm(reformulate(paste0('factor(QN', i+7, ')'), response = 'factor(QN26)'), design = yrbsdes, data = black_data, family = quasibinomial()))$coef[-1, "Pr(>|t|)"]
      df4 <- data.frame(value = part4) %>% na.omit()
}

df_26 <- data.frame(variable = c(1:5, 8:25, 30:64, 66:99), value = rbind(df1, df2, df3, df4))
df_26 %>%
  arrange(value)
```

```{r}
QN26 <- svyglm(QN26 ~ QN25+QN24+QN66+QN23+QN2, data = black_data, design = yrbsdes, family = quasibinomial())
summary(QN26)

#QN25: Felt sad or hopeless (Sad or hopeless)
#QN24: Were electronically bullied (Electronic bullying)
#QN66: sexual orientation
#QN23: Were bullied on school property (Bullying at school)
#QN41: Current alcohol use; Dependence: Required by QN44
#QN2: gender
 
black_data_QN26 <- black_data[, c('QN26', 'QN25', 'QN24', 'QN66', 'QN23', 'QN41','QN2')]
black_data_QN26 <- na.omit(black_data_QN26)

# predicted data
prediction <- predict(QN26, black_data_QN26, type="response")

# create roc curve
roc_object <- roc(black_data_QN26$QN26, prediction)
 
# calculate area under curve
auc(roc_object) 
```
```{r}
predROC <- function (glm.obj, newData, plot = TRUE)
{

  options(survey.lonely.psu="adjust")

  pred <- rep(NA, nrow(newData)); names(pred) <- rownames(newData)
  model_terms <- attributes(glm.obj$terms)$variables
  predictors <- as.character(model_terms[3:length(model_terms)])
  response <-  as.character(model_terms[2])
  newData <- newData[,c("WEIGHT",response,predictors)]
  xnn <- na.omit(newData)
  pred[-attr(xnn, "na.action")] <- predict(glm.obj, xnn)
  guess <- 1/(1+exp(-pred))
  dframe <- data.frame(response=ifelse(newData[, response]==0, -1, 1),
                       guess=guess,
                       WEIGHT=newData$WEIGHT)
  dframe <- na.omit(dframe)
  subset(WeightedROC::WeightedROC(dframe$guess, dframe$response, weight=dframe$WEIGHT), select=c(FPR, TPR))
}

simple_auc <- function(TPR, FPR){
  # inputs already sorted, best scores first 
  dFPR <- c(diff(FPR), 0)
  dTPR <- c(diff(TPR), 0)
  sum(TPR * dFPR) + sum(dTPR * dFPR)/2
}

QN26_ROC <- predROC(QN26, black_data, plot = TRUE)
# plot ROC curve
plot(QN26_ROC$FPR, QN26_ROC$TPR)
# find AUC
-simple_auc(QN26_ROC$TPR, QN26_ROC$FPR)
```

```{r}
# odds ratio
summ(QN26, exp = TRUE)

# 95% CI for odds ratio
round(exp(confint(QN26)), 2)
```

# QN27

```{r}
part1 <- c()
for (i in 1:5){
      part1[i] <- summary(svyglm(reformulate(paste0('factor(QN', i, ')'), response = 'factor(QN27)'), design = yrbsdes, data = black_data, family = quasibinomial()))$coef[-1, "Pr(>|t|)"]
      df1 <- data.frame(value = part1) %>% na.omit()
}

part2 <- c()
for (i in 1:18){
      part2[i] <- summary(svyglm(reformulate(paste0('factor(QN', i+7, ')'), response = 'factor(QN27)'), design = yrbsdes, data = black_data, family = quasibinomial()))$coef[-1, "Pr(>|t|)"]
      df2 <- data.frame(value = part2) %>% na.omit()
}

part3 <- c()
for (i in 23:57){
      part3[i] <- summary(svyglm(reformulate(paste0('factor(QN', i+7, ')'), response = 'factor(QN27)'), design = yrbsdes, data = black_data, family = quasibinomial()))$coef[-1, "Pr(>|t|)"]
      df3 <- data.frame(value = part3) %>% na.omit()
}

part4 <- c()
for (i in 59:92){
      part4[i] <- summary(svyglm(reformulate(paste0('factor(QN', i+7, ')'), response = 'factor(QN27)'), design = yrbsdes, data = black_data, family = quasibinomial()))$coef[-1, "Pr(>|t|)"]
      df4 <- data.frame(value = part4) %>% na.omit()
}

df_27 <- data.frame(variable = c(1:5, 8:25, 30:64, 66:99), value = rbind(df1, df2, df3, df4))
df_27 %>%
  arrange(value)
```

```{r}
QN27 <- svyglm(QN27 ~ QN25+QN23+QN2, data = black_data, design = yrbsdes, family = quasibinomial())
summary(QN27)

#QN25: Felt sad or hopeless (Sad or hopeless)
#QN23: Were bullied on school property (Bullying at school)
#QN24: Were electronically bullied (Electronic bullying)
#QN2: gender

QN27_ROC <- predROC(QN27, black_data, plot = TRUE)
plot(QN27_ROC$FPR, QN27_ROC$TPR)

-simple_auc(QN27_ROC$TPR, QN27_ROC$FPR) %>% round(2)
```

```{r}
# odds ratio
summ(QN27, exp = TRUE)

# 95% CI for odds ratio
exp(confint(QN27)) %>% round(2)
```

# QN28

```{r}
part1 <- c()
for (i in 1:5){
      part1[i] <- summary(svyglm(reformulate(paste0('factor(QN', i, ')'), response = 'factor(QN28)'), design = yrbsdes, data = black_data, family = quasibinomial()))$coef[-1, "Pr(>|t|)"]
      df1 <- data.frame(value = part1) %>% na.omit()
}


part2 <- c()
for (i in 1:18){
      part2[i] <- summary(svyglm(reformulate(paste0('factor(QN', i+7, ')'), response = 'factor(QN28)'), design = yrbsdes, data = black_data, family = quasibinomial()))$coef[-1, "Pr(>|t|)"]
      df2 <- data.frame(value = part2) %>% na.omit()
}

part3 <- c()
for (i in 23:57){
      part3[i] <- summary(svyglm(reformulate(paste0('factor(QN', i+7, ')'), response = 'factor(QN28)'), design = yrbsdes, data = black_data, family = quasibinomial()))$coef[-1, "Pr(>|t|)"]
      df3 <- data.frame(value = part3) %>% na.omit()
}

part4 <- c()
for (i in 59:92){
      part4[i] <- summary(svyglm(reformulate(paste0('factor(QN', i+7, ')'), response = 'factor(QN28)'), design = yrbsdes, data = black_data, family = quasibinomial()))$coef[-1, "Pr(>|t|)"]
      df4 <- data.frame(value = part4) %>% na.omit()
}

df_28 <- data.frame(variable = c(1:5, 8:25, 30:64, 66:99), value = rbind(df1, df2, df3, df4))
df_28 %>%
  arrange(value)
```

```{r}
QN28 <- svyglm(QN28 ~ QN23+QN25+QN2, data = black_data, design = yrbsdes, family = quasibinomial())
summary(QN28)

#QN23: Were bullied on school property (Bullying at school)
#QN25: Felt sad or hopeless (Sad or hopeless)
#QN1: age
#QN49: Ever took prescription pain medicine without a doctor's prescription or differently than how a doctor told them to use it (Ever prescription pain medicine use)
#QN2: gender

QN28_ROC <- predROC(QN28, black_data, plot = TRUE)
# plot ROC curve
plot(QN28_ROC$FPR, QN28_ROC$TPR)
# find AUC
-simple_auc(QN28_ROC$TPR, QN28_ROC$FPR) %>% round(2)
```

```{r}
# odds ratio
summ(QN28, exp = TRUE)

# 95% CI for odds ratio
exp(confint(QN28)) %>% round(2)
```

# QN29

## Method 1

```{r}
part1 <- c()
for (i in 1:5){
      part1[i] <- summary(svyglm(reformulate(paste0('factor(QN', i, ')'), response = 'factor(QN29)'), design = yrbsdes, data = black_data, family = quasibinomial()))$coef[-1, "Pr(>|t|)"]
      df1 <- data.frame(value = part1) %>% na.omit()
}

part2 <- c()
for (i in 1:18){
      part2[i] <- summary(svyglm(reformulate(paste0('factor(QN', i+7, ')'), response = 'factor(QN29)'), design = yrbsdes, data = black_data, family = quasibinomial()))$coef[-1, "Pr(>|t|)"]
      df2 <- data.frame(value = part2) %>% na.omit()
}

part3 <- c()
for (i in 23:57){
      part3[i] <- summary(svyglm(reformulate(paste0('factor(QN', i+7, ')'), response = 'factor(QN29)'), design = yrbsdes, data = black_data, family = quasibinomial()))$coef[-1, "Pr(>|t|)"]
      df3 <- data.frame(value = part3) %>% na.omit()
}

part4 <- c()
for (i in 59:92){
      part4[i] <- summary(svyglm(reformulate(paste0('factor(QN', i+7, ')'), response = 'factor(QN29)'), design = yrbsdes, data = black_data, family = quasibinomial()))$coef[-1, "Pr(>|t|)"]
      df4 <- data.frame(value = part4) %>% na.omit()
}

df_29_a <- data.frame(variable = c(1:5, 8:25, 30:64, 66:99), value = rbind(df1, df2, df3, df4))
df_29_a %>%
  arrange(value)
```

```{r}
# check the distribution
table(black_data$QN29, black_data$QN69) # Do not include
# b/c we have 0 cells, so there is no variation at all for QN69

table(black_data$QN28, black_data$QN50) # it is okay
table(black_data$QN28, black_data$QN52) # it is okay

QN29_a <- svyglm(QN29 ~ QN50+QN52+QN2, data = black_data, design = yrbsdes, family = quasibinomial())
summary(QN29_a)
#QN50: Ever used cocaine 
#QN52: Ever heroin use
#QN2: gender

QN29_a_ROC <- predROC(QN29_a, black_data, plot = TRUE)
# plot ROC curve
plot(QN29_a_ROC$FPR, QN29_a_ROC$TPR)
# find AUC
-simple_auc(QN29_a_ROC$TPR, QN29_a_ROC$FPR) %>% round(2)
```

```{r}
# odds ratio
summ(QN29_a, exp = TRUE)

# 95% CI for odds ratio
exp(confint(QN29_a)) %>% round(2)
```

## Method 2: Subgroup analysis

```{r}
# among those who had suicide attempt, let's see who has done severe suicide attempt
suicide_attempt <- black_data %>%
  filter(QN28 == 1)

# number of participants who had suicide attempt
nrow(suicide_attempt)

table(black_data$QN28, black_data$QN29)
37/154 ##24%
```

24% of participants had suicide attempt also had severe suicide attempt.

```{r}
# only study those who had severe suicide attempt among those who had suicide attempt
# weighted design data for the subgroup
yrbsdes_subgroup <- svydesign(
  id =  ~ PSU,
  weight =  ~ WEIGHT,
  strata =  ~ STRATUM,
  data = suicide_attempt,
  nest = TRUE
)

# The issue is because Stratum 102 has only one PSU sampled
# therefore there’s no variability to calculate the variance
options(survey.adjust.domain.lonely=TRUE)
options(survey.lonely.psu='certainty')
```

```{r, warning=FALSE}
part1 <- c()
for (i in 1:5){
      part1[i] <- summary(svyglm(reformulate(paste0('factor(QN', i, ')'), response = 'factor(QN29)'), design = yrbsdes_subgroup, data = suicide_attempt, family = quasibinomial()))$coef[-1, "Pr(>|t|)"]
      df1 <- data.frame(value = part1) %>% na.omit()
}

part2 <- c()
for (i in 1:18){
      part2[i] <- summary(svyglm(reformulate(paste0('factor(QN', i+7, ')'), response = 'factor(QN29)'), design = yrbsdes_subgroup, data = suicide_attempt, family = quasibinomial()))$coef[-1, "Pr(>|t|)"]
      df2 <- data.frame(value = part2) %>% na.omit()
}

part3 <- c()
for (i in 23:25){
      part3[i] <- summary(svyglm(reformulate(paste0('factor(QN', i+7, ')'), response = 'factor(QN29)'), design = yrbsdes_subgroup, data = suicide_attempt, family = quasibinomial()))$coef[-1, "Pr(>|t|)"]
      df3 <- data.frame(value = part3) %>% na.omit()
}

part4 <- c()
for (i in 27:57){
      part4[i] <- summary(svyglm(reformulate(paste0('factor(QN', i+7, ')'), response = 'factor(QN29)'), design = yrbsdes_subgroup, data = suicide_attempt, family = quasibinomial()))$coef[-1, "Pr(>|t|)"]
      df4 <- data.frame(value = part4) %>% na.omit()
}

part5 <- c()
for (i in 59:92){
      part5[i] <- summary(svyglm(reformulate(paste0('factor(QN', i+7, ')'), response = 'factor(QN29)'), design = yrbsdes_subgroup, data = suicide_attempt, family = quasibinomial()))$coef[-1, "Pr(>|t|)"]
      df5 <- data.frame(value = part5) %>% na.omit()
}

df_29_b <- data.frame(variable = c(1:5, 8:25, 30:32, 34:64, 66:99), value = rbind(df1, df2, df3, df4, df5))
df_29_b %>%
  arrange(value)
```

```{r, warning=FALSE}
table(suicide_attempt$QN29, suicide_attempt$QN43) # It is NOT okay

QN29_b <- svyglm(
    QN29 ~ QN54+QN2,
    data = suicide_attempt,
    design = yrbsdes_subgroup,
    family = quasibinomial()
  )

summary(QN29_b)

# QN54: Ever ecstasy use 

QN29_b_ROC <- predROC(QN29_b, suicide_attempt, plot = TRUE)
# plot ROC curve
plot(QN29_b_ROC$FPR, QN29_b_ROC$TPR)
# find AUC
-simple_auc(QN29_b_ROC$TPR, QN29_b_ROC$FPR)  %>% round(2)
```

```{r}
# odds ratio
summ(QN29_b, exp = TRUE)

# 95% CI for odds ratio
exp(confint(QN29_b)) %>% round(2)
```
